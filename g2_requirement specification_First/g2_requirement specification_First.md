# 要求仕様書 ver.6
作成日：2025/05/08  
更新日：2025/06/12
版数：5
   -   第1版：5月8日
   -   第2版：5月14日
   -   第3版：5月21日
   -   第4版：5月29日
   -   第5版：6月9日  
作成者：小野田、田中、渡辺

## 1. 概要

　本システムは、大学生協の座席予約を行うためのWebアプリケーションと、その管理機能で構成される。ユーザーは、Web（ブラウザ）上で座席の予約・変更・キャンセルを行い、大学生協の入口でチェックインをすることで座席の確保を行うことが可能である。（予約をしなくてもチェックインの際に、その場で座席の確保ができる仕組みも取り入れる。）なお、管理者は、予約状況の管理・座席の管理・システムの設定等を行うことができる。

## 2. 用語
-   **システム利用時間帯**
    -   10:30-13:30 (大生営業時間11:00-13:30)
-   **予約ユーザー**
    -   システムを利用して座席を予約するユーザー。
-   **予約していないユーザー**
    -  　システムで座席を予約していないユーザー。チェックイン時に手続きを行う。
-   **認証**
    -   ユーザー新規登録の際、IDが不正な文字列でないかチェックした上で、自動でデータベースに追加
    -   認証方法
        -   通常認証：ユーザーIDとパスワードを入力
        -   Googleアカウント認証    
    -   データベース内で、同一のIDがある場合には、新規登録不可（通常認証とGoogleアカウント認証では重複可能）
    -   **ユーザー番号**    
        -   UUIDv7を使用。
        -   新規発行時に自動で生成
    -   **ユーザーID**
        -   6文字以上30文字以下。
    -   **パスワード**
        -   英数の大文字・小文字のみ。
        -   8文字以上64文字以下。
        -   ユーザーID、秘密の質問により再設定可能。
    -   **秘密の質問**
        -   ユーザーは、自分で”質問”とその”回答”を1つずつ設定
        -   10回失敗でアカウントロック
            -   3時間後にロックを解除
        -   日本語8文字以上64文字以下
-   **QRコード**
    -   チェックイン時に使用される
    -   予約情報に紐づいたQRコード
    -   QR code API等を使用
    -   予約番号をもとに生成
    -   **チェックインシステム設置場所**
        -   大学生協の入口など、利用者がアクセスしやすい場所に設置
-   **予約情報**   
    -   予約に関する詳細データ
        -   予約番号
        -   人数（1～8人）
        -   予約日時
        -   滞在予定時間
        -   座席指定：視覚的に表示
-   **予約番号**
    -   各予約を識別するためのID
    -   予約順に番号を決定
-   **滞在予定時間**
    -   ユーザーが座席を利用する予定の時間を予約やチェックインの際に収集。
    -   **パラメータ**  
        -   管理者により時間を10分単位で変更可能
        -   「すぐ食べ終わる」:20分
        -   「ゆっくり食べる」:40分
        -   「長時間滞在予定」:60分
        -    滞在に関わらずその時間は席が使われている状態にしておく
-   **チェックイン**
    -   大生の入口でユーザーが予約した座席またはその場で確保した座席の利用開始の手続きを行う
-   **チェックアウト**
    -   Webサイト上で利用終了の手続きを行う
-   **管理者ID・パスワード**
    -   管理者一人一人に発行
    -   データベース作成時に、管理用・非常用等いくつかのID・パスワードを発行
        -   以降は、その既に追加したIDでログインした管理者サイト内で認証
        -   ID：10文字以上30文字以下
        -   パスワード：12文字以上64文字以下
-   **予約用ユーザーサイト**
    -   ユーザーが座席の予約、変更、キャンセル登録等を行うためのWebサイト
-   **管理者サイト**
    -   管理者がシステムの管理・運用を行うためのWebサイト
-   **チェックインシステム**
    -   ユーザーが大学生協の入口でチェックインを行うための端末に使用されるWebサイト
        -   QRコードリーダーと新規予約機能をもつ
-   **仮予約**
    -   ユーザーが座席を選択した時点で2分間座席を確保する状態
    -   ユーザーが座席を選択した際、座席に仮予約の状態を付与する
    -   2分以上経った場合、仮予約をキャンセル
-   **ID**
    -   UUIDv7を使用
        -   128bitの値で、対象を一意に識別する
        -   時間情報も含む

## 3. 機能要件

### ユーザー向け機能
-   **新規ユーザー登録**
    -  ユーザーは、ユーザーID・パスワード・秘密の質問と回答を入力し、新規ユーザー登録を行う。
-   **ログイン機能**
    -  ユーザーは、ユーザーID とパスワードを入力し、ログインを行う。
-   **ログアウト機能**
    -  ユーザーは、ログイン状態でログアウトボタンを押すことで、ログアウトを行う。
-   **パスワード再設定機能**
    -  ユーザーは、ユーザーID と秘密の質問と回答を入力することで、パスワードの再設定が可能となる。
-   **秘密の質問再設定機能**
    -  ユーザーは、ログインした状態で、ユーザーID に紐づいた秘密の質問と回答が変更可能である。
-   **チェックイン用 QR コード・予約情報表示機能**
    -  ユーザーは、ログインした状態で、予約情報を確認することが可能である。
    -  チェックアウトに必要な QR コードも同様に確認可能である。
-   **新規予約機能**
    -  ユーザーは、予約情報（予約時間・人数・滞在予定時間）を入力すると、10 分ごとの座席の予約状態をマップ形式で確認でき、その中の空席から希望の座席を選び、予約を行うことが可能である。
    -  予約情報の入力時に、座席選択の有無を入力する項目を用意し、座席指定を必要としないユーザーには、自動的に座席を割り振る。
    -  **空席確認機能**
        -  ユーザーは、予約情報を入力することで、席の空き状況をマップ形式で視覚的に確認できる。
        -  ユーザーは、希望する座席を指定すると仮予約が成立する。（仮予約は、2 分以内に予約を確定させない場合に、自動的にキャンセルされる。）
        -  ユーザーは、1 つのアカウントにつき 1 件の予約までしか同時にとることができない。（予約後に、画面内に、予約情報の表示・変更・キャンセルの項目のみ表示され、新規予約が取れないようにする。）
-    **予約変更機能**
    -  ユーザーは、新規予約後に表示される変更を選択した場合、予約情報の一部を変更することができる。
    -  変更時には、予約を保持したまま、新たな予約に変更する手続きを行うことができるが、新たな予約を確定させた場合には、元の予約は削除される。
-    **予約キャンセル機能**
    -  ユーザーは、新規予約後に表示されるキャンセルを選択した場合、予約時間まではキャンセルが可能である。
#### チェックイン機能
-   **予約有無選択機能**
    -  ユーザーは、「予約している」か「予約していない」かを選択することで、チェックインの方法を選択することができる。
    -  **予約している場合**
        -   ユーザーは、チェックインシステムに予約時刻の10分後までにQRコードをかざす。
    -  **予約していない場合**
        -   ユーザーは、チェックインシステムで座席が確保できる。
        -   このとき、予約情報（予約時間・人数・滞在予定時間・座席指定）を入力することで、座席を確保する。
#### チェックアウト機能
-   ユーザーは、チェックアウトを予約時間中に行える。
### 管理者向け機能
-    **ログイン機能**
    -   管理者は、管理者 ID とパスワードを入力することで、管理者用サイトにログインすることができる。
    -   管理者の ID とパスワードは、初期設定時を除き、ログインした状態で追加・削除・変更が可能である。
-   **ログアウト機能**
    -   管理者は、管理者用サイト内のログアウトボタンを押すことで、ログアウトを行うことができる。
-   **予約管理機能**
    -   管理者は、予約されている情報・時間ごとの座席情報の一覧を確認することができる。
    -   管理者は、ユーザーID または予約番号で予約情報を検索・削除・変更することができる
-   **予約取消機能**
    -   管理者は、特定の予約を強制的にキャンセルすることができる。
-   **座席混雑マップ表示機能**
    -   管理者は日時を選択すると、10 分ごとの座席の予約状態をマップで表示することができる。
-   **予約受付強制停止機能**
    -   管理者はシステム全体または特定時間帯の新規予約受付を一時的に停止することができる。
-   **チェックインシステム管理機能**
    -   ユーザーが QR コードが読み込めなかった場合、ユーザーがユーザーID または整理番号の手入力によりチェックインを行うことができる。
-   **システム設定機能**
    -   管理者は、予約情報のパラメータ（予約可能時間・滞在予定時間の候補）を設定可能である。

## 4. 非機能要件

### 信頼性・正確性
-   オーバーブッキング防止
    -   座席選択時に仮予約（一定時間(＝2分）を確保）を行い、他のユーザーとの同時予約による重複を防ぐ
    -   新規予約のボタンを押した段階で整理番号を発行し、データベースに書き込む順番を決定
        -   整理番号は発行するが、書き込む順番を決めるのには用いない（予約していないユーザーの座席管理を考慮）
            -   座席の空席状況は、新規予約（あるいは変更）を押したタイミングでの座席管理情報を反映
            -   書き込みに関しては、仮予約として情報をデータベースに送信する
            -   座席が取れた・取れなかったの旨をデータとして取得…ポップアップに表示

### セキュリティ
-   機密性について
    -   管理者サイトへのアクセスは一意のIDとパスワードによる認証を必須とし、権限のないユーザーのアクセスを防止すること
    -   全てのWebページにおいてHTTPSを使用して通信データを暗号化すること
    -   QRコードの生成については、当日より前の日に利用した同じ予約番号の人が使えないようにすること
        -   日付情報やUUIDを用いる等のデータベースとの連携が必要   
    -   XSS対策
        -   バリデーション処理を行い入力値に制限をかけ、許可されたデータのみを受け取る
        -   WAFを設置して悪意のあるリクエストを拒否する
- 　完全性について
    -   ユーザーとシステム間で送受信されるデータが、第三者に改善されないようHTTPSを使用することで通信データを暗号化し、データの完全性を保証すること
    -   入力値検証をサーバーサイドでも行い、不正なスクリプトの入力を禁止
    -   予約情報の入力には、SELECTタグ等のユーザーが直接入力できないようにする対策を実施
        -   ユーザーのID・パスワード、管理者用のID・パスワード以外には、ユーザーが直接入力できないようにする
    -   ID・パスワードの形式が正しいか、不正な文字列でないかチェックをすること
        -   文字数オーバー、すでに登録されている等    
    -   禁止する特定の文字列（script・データベースの追加や削除のコードなど）を検出し、拒否する方式を取ること
    -   30（ID）、64文字（パスワード）以上の極端に長い文字列を禁止すること
-   可用性について
    -   DDoS攻撃への対策
        -   Firewallの設定をすること
　	    -   攻撃元のIPアドレスを特定できた際に、ブロックリストに追加すること
            （実際には、学内Wi-Fi等は、たくさんのユーザーが利用することを考慮）　
        -   大量のアクセスによるサービス停止を防ぐための対策を検討（IPアドレス制限、リクエストレート制限等）
        -   10回ログインを失敗時には、アカウントを自動削除（ブルートフォース攻撃対策）
        -   レートリミット
            -一定期間内の送信数を制限する
    -   ログインできない
        -   秘密の質問
        -   Gmail APIシステムが導入できれば、ログインなしでメールアドレスを入力できるようにして、そのメールアドレスにQRコードを送信。

### ユーザビリティ
-   アイコンと文字を効果的に使用し、ユーザーが迷わず操作
    -   ナビゲーションバー等
-   入力情報の保持
    -   画面遷移時には、既に入力された情報を保持し、再入力の手間を省く
    -   Cookieを使用：ユーザビリティを考慮して、Cookieを使用しますかはあまり出したくない
-   操作制限
    -   チェックイン画面で管理者側の意図しない情報や操作を行えないように、機能を制限
-   多言語対応
    -   日本語および英語に対応（予約ユーザーサイト・チェックイン画面のみ）
    自動ログアウト
    -    10分間操作がない場合には、自動的にログアウト

### 性能
-   大量アクセス対応
    -   多数の同時アクセスに対応

### 運用・保守性
-   管理者複数ログイン対応
    -   複数の管理者が同時に管理者サイトにログインして作業可能
-   QRコード自動化
    -   予約確定時や変更時に、QRコードを自動で生成し出力
    -   QR code APIを使用
    サーバーのメンテナンス
        サーバーメンテナンス時間の設定（20:00～翌6:00）
    -   予約時間外は、サーバーメンテナンス（ユーザーには、非表示）
    各種障害時の対応
    -   座席が同じタイミングで仮予約
        -   UUIDをもとに、ランダム関数を用いて、優先度を決定
    -   予約処理のエラー：すでにとられている等
        -   データベースからの情報に基づいて、ユーザー画面内にポップアップを通知
    -   データベースエラー・予約情報のエラー（できれば）
        -   ユーザーに画面内の通知機能でその旨を通知し、すべてのユーザー機能（チェックインも含む）を停止。
    -   QRコードの不具合
        -   ユーザーに画面内の通知機能でその旨を通知
        -   QRコード再生成（ボタン）
        -   QRコードが生成できない場合には、ユーザーIDまたは整理番号を管理者が入力